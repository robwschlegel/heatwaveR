<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saving MHW Results to NetCDF • heatwaveR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/spacelab/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Saving MHW Results to NetCDF">
<meta property="og:description" content="This vignette demonstrates how to save marine heatwaves (MHWs) detected from gridded data as a NetCDF file.">
<meta property="og:image" content="https://robwschlegel.github.io/heatwaveR/index.html/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-118123016-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118123016-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">heatwaveR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.2.9009</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/detection_and_visualisation.html">Basic Detection and Visualisation of Events</a>
    </li>
    <li>
      <a href="../articles/event_categories.html">Calculating and Visualising Event Categories</a>
    </li>
    <li>
      <a href="../articles/exceedance.html">Calculating and Visualising Exceedances</a>
    </li>
    <li>
      <a href="../articles/complex_clims.html">Alternative Thresholds</a>
    </li>
    <li>
      <a href="../articles/MHW_metric_trends.html">Trend and Breakpoint Analyses</a>
    </li>
    <li>
      <a href="../articles/OISST_preparation.html">Downloading and Preparing OISST Data</a>
    </li>
    <li>
      <a href="../articles/gridded_event_detection.html">Detecting Events in Gridded Data</a>
    </li>
    <li>
      <a href="../articles/Download_SST_v2.html">Download, Prepare, and Analyse Data: Alternative</a>
    </li>
    <li>
      <a href="../articles/MHW_to_nc.html">Saving MHW Results to NetCDF</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://193.50.85.71:3838/demoMHW/" class="external-link">Tutorial</a>
</li>
<li>
  <a href="../CITATIONS.html">Citations</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/robwschlegel/heatwaveR" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Saving MHW Results to NetCDF</h1>
                        <h4 data-toc-skip class="author">Robert W
Schlegel</h4>
            
            <h4 data-toc-skip class="date">2024-01-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/robwschlegel/heatwaveR/blob/HEAD/vignettes/MHW_to_nc.Rmd" class="external-link"><code>vignettes/MHW_to_nc.Rmd</code></a></small>
      <div class="hidden name"><code>MHW_to_nc.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>In the previous vignette we saw how to <a href="https://robwschlegel.github.io/heatwaveR/articles/gridded_event_detection.html" class="external-link">detect
marine heatwaves (MHWs) in gridded data</a>. In this vignette we will
use those gridded MHW results to see how to save them as a NetCDF
file.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># For basic data manipulation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cirrus.ucsd.edu/~pierce/ncdf/" class="external-link">ncdf4</a></span><span class="op">)</span> <span class="co"># For creating NetCDF files</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/tidync/" class="external-link">tidync</a></span><span class="op">)</span> <span class="co"># For easily dealing with NetCDF data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span> <span class="co"># For visualising data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span> <span class="co"># For parallel processing</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="loading-data">Loading data<a class="anchor" aria-label="anchor" href="#loading-data"></a>
</h2>
<p>Please see the <a href="https://robwschlegel.github.io/heatwaveR/articles/OISST_preparation.html" class="external-link">downloading
and preparing OISST data</a> and <a href="https://robwschlegel.github.io/heatwaveR/articles/gridded_event_detection.html" class="external-link">detecting
marine heatwaves (MHWs) in gridded data</a> vignettes first if you have
not yet worked through them. We will be using the MHW results created
from those two vignettes below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MHW_res_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"~/Desktop/MHW_result.Rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-the-data">Prepare the data<a class="anchor" aria-label="anchor" href="#prepare-the-data"></a>
</h2>
<p>The main sticking point between MHW results and the NetCDF file
format in R is that NetCDF files will only accept the file type in R
known as “arrays”, and most R outputs are data.frames. So the majority
of what we need to do is to convert our data from data.frames to arrays.
There are many ways to do this and a search of the interwebs will
produce a plethora of results. Over the years I have settled into an
approach that I use operationally for the MHW Tracker that I will also
use here. It is not necessarily the fastest method, nor does it use the
fewest lines of code possible, but it does follow the
<strong><code>tidyverse</code></strong> approach to programming, and I
think it is about as transparent as this process can be. We will create
two functions below that will help us along in this process.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function for creating arrays from data.frames</span></span>
<span><span class="va">df_acast</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">lon_lat</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Force grid</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="va">lon_lat</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Convert date values to integers if they are present</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/date_utils.html" class="external-link">is.Date</a></span><span class="op">(</span><span class="va">res</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="va">res</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">res</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create array</span></span>
<span>  <span class="va">res_array</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="va">res</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lon_lat</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lon_lat</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">res_array</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lon_lat</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span>,</span>
<span>                              lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lon_lat</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res_array</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Wrapper function for last step before data are entered into NetCDF files</span></span>
<span><span class="va">df_proc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">col_choice</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Determine the correct array dimensions</span></span>
<span>  <span class="va">lon_step</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">lat_step</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">lon_step</span><span class="op">)</span></span>
<span>  <span class="va">lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">lat_step</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create full lon/lat grid</span></span>
<span>  <span class="va">lon_lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>lon <span class="op">=</span> <span class="va">lon</span>, lat <span class="op">=</span> <span class="va">lat</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Acast only the desired column</span></span>
<span>  <span class="va">dfa</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/daply.html" class="external-link">daply</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span>, <span class="st">"event_no"</span>, <span class="va">col_choice</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"event_no"</span><span class="op">)</span>, <span class="va">df_acast</span>, .parallel <span class="op">=</span> <span class="cn">T</span>, lon_lat <span class="op">=</span> <span class="va">lon_lat</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dfa</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># We must now run this function on each column of data we want to add to the NetCDF file</span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">prep_dur</span> <span class="op">&lt;-</span> <span class="fu">df_proc</span><span class="op">(</span><span class="va">MHW_res_grid</span>, <span class="st">"duration"</span><span class="op">)</span></span>
<span><span class="va">prep_max_int</span> <span class="op">&lt;-</span> <span class="fu">df_proc</span><span class="op">(</span><span class="va">MHW_res_grid</span>, <span class="st">"intensity_max"</span><span class="op">)</span></span>
<span><span class="va">prep_cum_int</span> <span class="op">&lt;-</span> <span class="fu">df_proc</span><span class="op">(</span><span class="va">MHW_res_grid</span>, <span class="st">"intensity_cumulative"</span><span class="op">)</span></span>
<span><span class="va">prep_peak</span> <span class="op">&lt;-</span> <span class="fu">df_proc</span><span class="op">(</span><span class="va">MHW_res_grid</span>, <span class="st">"date_peak"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-netcdf-shell">Create NetCDF shell<a class="anchor" aria-label="anchor" href="#create-netcdf-shell"></a>
</h2>
<p>With our data prepared into a series of arrays, we now need to set
the stage for our NetCDF file. The important thing here is that the
dimensions of the arrays we created match up to the dimensions of the
NetCDF file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get file attributes</span></span>
<span><span class="va">lon_step</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lat_step</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">lon</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">lon_step</span><span class="op">)</span></span>
<span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">lat_step</span><span class="op">)</span></span>
<span><span class="va">event_no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">event_no</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">MHW_res_grid</span><span class="op">$</span><span class="va">event_no</span><span class="op">)</span>, by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">tunits</span> <span class="op">&lt;-</span> <span class="st">"days since 1970-01-01"</span></span>
<span></span>
<span><span class="co"># Length of each attribute</span></span>
<span><span class="va">nlon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lon</span><span class="op">)</span></span>
<span><span class="va">nlat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lat</span><span class="op">)</span></span>
<span><span class="va">nen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">event_no</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-netcdf-file">Create NetCDF file<a class="anchor" aria-label="anchor" href="#create-netcdf-file"></a>
</h2>
<p>The last step in this process is to add the prepared data to the
NetCDF shell we have constructed. The
<strong><code>ncdf4</code></strong> package helps to make this all a
relatively straight forward process.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path and file name</span></span>
<span>  <span class="co"># NB: We are net setting time dimensions here because we are using event_no as our "time" dimension</span></span>
<span><span class="va">ncpath</span> <span class="op">&lt;-</span> <span class="st">"~/Desktop/"</span></span>
<span><span class="va">ncname</span> <span class="op">&lt;-</span> <span class="st">"MHW_results"</span></span>
<span><span class="va">ncfname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">ncpath</span>, <span class="va">ncname</span>, <span class="st">".nc"</span><span class="op">)</span></span>
<span><span class="co"># dname &lt;- "tmp"</span></span>
<span></span>
<span><span class="co"># Define dimensions</span></span>
<span><span class="va">londim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncdim_def.html" class="external-link">ncdim_def</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"degrees_east"</span>, <span class="va">lon</span><span class="op">)</span></span>
<span><span class="va">latdim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncdim_def.html" class="external-link">ncdim_def</a></span><span class="op">(</span><span class="st">"lat"</span>, <span class="st">"degrees_north"</span>, <span class="va">lat</span><span class="op">)</span></span>
<span><span class="va">endim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncdim_def.html" class="external-link">ncdim_def</a></span><span class="op">(</span><span class="st">"event_no"</span>, <span class="st">"event_number"</span>, <span class="va">event_no</span><span class="op">)</span></span>
<span><span class="co"># timedim &lt;- ncdim_def("time", tunits, as.double(time))</span></span>
<span></span>
<span><span class="co"># Define variables</span></span>
<span><span class="va">fillvalue</span> <span class="op">&lt;-</span> <span class="fl">1e32</span></span>
<span><span class="va">def_dur</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_def.html" class="external-link">ncvar_def</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"duration"</span>, units <span class="op">=</span> <span class="st">"days"</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">endim</span>, <span class="va">latdim</span>, <span class="va">londim</span><span class="op">)</span>, </span>
<span>                     missval <span class="op">=</span> <span class="va">fillvalue</span>, longname <span class="op">=</span> <span class="st">"duration of MHW"</span>, prec <span class="op">=</span> <span class="st">"double"</span><span class="op">)</span></span>
<span><span class="va">def_max_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_def.html" class="external-link">ncvar_def</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"max_int"</span>, units <span class="op">=</span> <span class="st">"deg_c"</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">endim</span>, <span class="va">latdim</span>, <span class="va">londim</span><span class="op">)</span>, </span>
<span>                         missval <span class="op">=</span> <span class="va">fillvalue</span>, longname <span class="op">=</span> <span class="st">"maximum intensity during MHW"</span>, prec <span class="op">=</span> <span class="st">"double"</span><span class="op">)</span></span>
<span><span class="va">def_cum_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_def.html" class="external-link">ncvar_def</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"cum_int"</span>, units <span class="op">=</span> <span class="st">"deg_c days"</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">endim</span>, <span class="va">latdim</span>, <span class="va">londim</span><span class="op">)</span>, </span>
<span>                         missval <span class="op">=</span> <span class="va">fillvalue</span>, longname <span class="op">=</span> <span class="st">"cumulative intensity during MHW"</span>, prec <span class="op">=</span> <span class="st">"double"</span><span class="op">)</span></span>
<span><span class="va">def_peak</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_def.html" class="external-link">ncvar_def</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"date_peak"</span>, units <span class="op">=</span> <span class="va">tunits</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">endim</span>, <span class="va">latdim</span>, <span class="va">londim</span><span class="op">)</span>,</span>
<span>                      missval <span class="op">=</span> <span class="fl">0</span>, longname <span class="op">=</span> <span class="st">"date of peak temperature anomaly during MHW"</span>, prec <span class="op">=</span> <span class="st">"integer"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create netCDF file and prepare space for our arrays</span></span>
<span><span class="va">ncout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_create.html" class="external-link">nc_create</a></span><span class="op">(</span><span class="va">ncfname</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">def_peak</span>, <span class="va">def_dur</span>, <span class="va">def_max_int</span>, <span class="va">def_cum_int</span><span class="op">)</span>, force_v4 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the actual data</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ancvar_put.html" class="external-link">ncvar_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="va">def_dur</span>, <span class="va">prep_dur</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ancvar_put.html" class="external-link">ncvar_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="va">def_max_int</span>, <span class="va">prep_max_int</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ancvar_put.html" class="external-link">ncvar_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="va">def_cum_int</span>, <span class="va">prep_cum_int</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ancvar_put.html" class="external-link">ncvar_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="va">def_peak</span>, <span class="va">prep_peak</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Put additional attributes into dimension and data variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="st">"lon"</span>, <span class="st">"axis"</span>, <span class="st">"X"</span><span class="op">)</span> <span class="co">#,verbose=FALSE) #,definemode=FALSE)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="st">"lat"</span>, <span class="st">"axis"</span>, <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="st">"event_no"</span>, <span class="st">"axis"</span>, <span class="st">"event_no"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add global attributes</span></span>
<span>  <span class="co"># These are useful for whomever else may want to use your NetCDF file</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="fl">0</span>, <span class="st">"title"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"MHW results from lon: "</span>,</span>
<span>                                    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">lon</span><span class="op">)</span>,<span class="st">" to "</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lon</span><span class="op">)</span>,</span>
<span>                                    <span class="st">" and lat: "</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">lat</span><span class="op">)</span>,<span class="st">" to "</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="fl">0</span>, <span class="st">"institution"</span>, <span class="st">"Your institution here!"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="fl">0</span>, <span class="st">"source"</span>, <span class="st">"NOAA OISST v2.1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>,<span class="fl">0</span>, <span class="st">"references"</span>, <span class="st">"Banzon et al. (2020) J. Atmos. Oce. Tech. 37:341-349"</span><span class="op">)</span></span>
<span><span class="va">history</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Your name here!, "</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/date.html" class="external-link">date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="fl">0</span>, <span class="st">"history"</span>, <span class="va">history</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_put.html" class="external-link">ncatt_put</a></span><span class="op">(</span><span class="va">ncout</span>, <span class="fl">0</span>, <span class="st">"Conventions"</span>, <span class="st">"Hobday et al. (2016)"</span><span class="op">)</span> <span class="co"># Assuming one has used the Hobday definition</span></span>
<span></span>
<span><span class="co"># Get a summary of the created file:</span></span>
<span><span class="va">ncout</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualising-the-results">Visualising the results<a class="anchor" aria-label="anchor" href="#visualising-the-results"></a>
</h2>
<p>Let’s not stop there. To ensure that the NetCDF file was created
correctly we want to load it back into our workspace and plot the
results.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convenience function for comparing files</span></span>
<span><span class="va">quick_grid</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">var_choice</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">event_no</span> <span class="op">==</span> <span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_.html" class="external-link">aes_string</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">var_choice</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Thanks to the tidync package, loading the gridded data is very simple</span></span>
<span><span class="va">MHW_res_nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/tidync/reference/tidync.html" class="external-link">tidync</a></span><span class="op">(</span><span class="st">"~/Desktop/MHW_results.nc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/tidync/reference/hyper_tibble.html" class="external-link">hyper_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date_peak <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date_peak</span>, origin <span class="op">=</span> <span class="st">"1970-01-01"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the duration results</span></span>
<span><span class="fu">quick_grid</span><span class="op">(</span><span class="va">MHW_res_grid</span>, <span class="st">"duration"</span><span class="op">)</span></span>
<span><span class="fu">quick_grid</span><span class="op">(</span><span class="va">MHW_res_nc</span>, <span class="st">"duration"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cumulative intensity</span></span>
<span><span class="fu">quick_grid</span><span class="op">(</span><span class="va">MHW_res_grid</span>, <span class="st">"intensity_cumulative"</span><span class="op">)</span></span>
<span><span class="fu">quick_grid</span><span class="op">(</span><span class="va">MHW_res_nc</span>, <span class="st">"cum_int"</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Robert W. Schlegel, Albertus J. Smit.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '2edc7627dae0471f3d765c3355bebbf3',
    indexName: 'heatwaver',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
